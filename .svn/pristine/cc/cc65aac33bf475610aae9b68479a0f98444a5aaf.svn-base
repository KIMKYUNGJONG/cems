!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports):"function"==typeof define&&define.amd?define(["exports"],i):i((t.ht=t.ht||{},t.ht.thermodynamic={}))}(this,function(t){"use strict";var r=((0,eval)("this")||(0,eval)("global")||(0,eval)("window")).ht,i=function(t,i,e){return i&&a(t.prototype,i),e&&a(t,e),t};function a(t,i){for(var e=0;e<i.length;e++){var a=i[e];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}var c=r.Math.Vector3,p=r.Default,n=window.setTimeout,g="t_horizontal",y="t_xVertical",m="t_yVertical",s="_thermodynamicBox",e={min:10,max:100,radius:50,box:new c(20,20,20),step:.1,colorStopFn:function(t,i){return t*i*i*i},remainMax:!1,gradient:{0:"rgba(0,162,255,0.14)",.2:"rgba(48,255,183,0.30)",.4:"rgba(255,245,48,0.50)",.6:"rgba(255,73,18,0.90)",.8:"rgba(217,22,0,0.95)",1:"rgb(179,0,0)"},opacity:.1,interval:10,blur:1},h=(i(o,[{key:"setData",value:function(t){this.temperatureList=t}},{key:"getDatas",value:function(){return this.temperatureList}},{key:"configure",value:function(t){var i,e,a,n=this.config.gradient;this.config=Object.assign(this.config,t),i=n,e=this.config.gradient,a=!0,i===e||Object.keys(i).forEach(function(t){a&&(e[t]&&i[t]===e[t]||(a=!1))}),a||(this.palette=this.getColorPalette(n))}},{key:"setThermodynamicBox",value:function(t,i,e){this.config.box=new c(t,i,e)}},{key:"getPointInfo",value:function(t){var i=this.config;return p.isObject(t)?{value:t.value,radius:t.radius}:{value:t,radius:i.radius}}},{key:"createThermodynamicNode",value:function(t,i,e){var a=this.config.box;this.t=t,this.i=i,this.e=e,this.a=p.getId(),this.loadThermodynamicMoel(t,i,e);var n=this.n=new r.Node;return n.s3(a.x,a.z,a.y),n.s({shape3d:this.getThermodynamicModelName(),"wf.visible":!0,"shape3d.transparent":!0}),n}},{key:"loadThermodynamicMoel",value:function(t,i,e){this.r={},this.h={},this.destoryModels(),this.destoryImage(),function(t,i,e){var a=this;n(function(){e&&function(t){for(var h=this,o=this.g3d,u=this.config,v=u.box,c=[],f=[],l=[],d=1/(t-1),y=[],i=function(s){n(function(){var t=s*d,i=p.getId(),e=[g,"_model_",i].join(""),a=[g,"_image_",i].join(""),n=h.o[a],r=n&&n.getContext("2d");c=[-.5,t-.5,-.5,.5,t-.5,-.5,.5,t-.5,.5,-.5,t-.5,.5],f=[2,1,0,0,3,2],l=[0,0,1,0,1,1,0,1],p.setShape3dModel(e,{vs:c,is:f,uv:l,image:a,color:"rgb(90,171,224)",reverseFlip:!0,transparent:u.opacity<1,opacity:u.opacity}),n=h.getHeatMap(d*s*v.z,"z",null,r),p.setImage(a,n),y.push({shape3d:e}),h.o[a]=n,h.u.push(e),h.v.push(a),p.setShape3dModel(g+h.a,y),o&&o.invalidateData(h.n)},u.interval*s)},e=0;e<t;e++)i(e)}.call(a,e),t&&function(t){for(var h=this,o=this.config,u=o.box,v=[],c=[],f=[],l=1/(t-1),d=[],i=function(s){n(function(){var t=s*l,i=p.getId(),e=[y,"_model_",i].join(""),a=[y,"_image_",i].join(""),n=h.o[a],r=n&&n.getContext("2d");v=[-.5,-.5,t-.5,.5,-.5,t-.5,.5,.5,t-.5,-.5,.5,t-.5],c=[2,1,0,2,3,0],f=[0,0,1,0,1,1,0,1],p.setShape3dModel(e,{vs:v,is:c,uv:f,image:a,color:"rgb(90,171,224)",reverseFlip:!0,transparent:o.opacity<1,opacity:o.opacity}),n=h.getHeatMap(l*s*u.y,"x",null,r),p.setImage(a,n),d.push({shape3d:e}),h.o[a]=n,h.u.push(e),p.setShape3dModel(y+h.a,d)},o.interval*s)},e=0;e<t;e++)i(e)}.call(a,t),i&&function(t){for(var h=this,o=this.config,u=o.box,v=[],c=[],f=[],l=1/(t-1),d=[],i=function(s){n(function(){var t=s*l,i=p.getId(),e=[m,"_model_",i].join(""),a=[m,"_image_",i].join(""),n=h.o[a],r=n&&n.getContext("2d");v=[t-.5,-.5,.5,t-.5,-.5,-.5,t-.5,.5,-.5,t-.5,.5,.5],c=[2,1,0,2,3,0],f=[0,0,1,0,1,1,0,1],p.setShape3dModel(e,{vs:v,is:c,uv:f,image:a,color:"rgb(90,171,224)",reverseFlip:!0,transparent:o.opacity<1,opacity:o.opacity}),n=h.getHeatMap(l*s*u.x,"y",null,r),p.setImage(a,n),d.push({shape3d:e}),h.o[a]=n,h.u.push(e),p.setShape3dModel(m+h.a,d)},o.interval*s)},e=0;e<t;e++)i(e)}.call(a,i)},0),p.setShape3dModel(s+this.a,[{shape3d:g+this.a},{shape3d:y+this.a},{shape3d:m+this.a}])}.call(this,t,i,e)}},{key:"getThermodynamicModelName",value:function(){return this.a||(this.a=p.getId()),s+this.a}},{key:"renderAll",value:function(){var u=this,v=this.config,c=v.remainMax,f=v.gradient,l=this.r||{},d=this.h||{};Object.keys(l).forEach(function(t){var i=l[t],e=d[t],a=t.split("_"),n=a[0],r=a[1],s=b(n,u.config.box,{},v.blur),h=i.canvas;h.width=s.x,h.height=s.y,u.renderPoints(r,n,c,i);var o=e.canvas;o.width=s.x,o.height=s.y,u.renderCanvas(f,c,i,e)})}},{key:"renderCanvas",value:function(t,i,e,a){for(var n=t?this.getColorPalette(t):this.palette,r=e.canvas,s=e.getImageData(0,0,r.width,r.height),h=s.data,o=h.length,u=i?0:3,v=0;v<o;v+=4){var c=4*h[v+u];h[v]=n[c],h[v+1]=n[1+c],h[v+2]=n[2+c],h[v+3]=n[3+c]}a.putImageData(s,0,0)}},{key:"renderPoints",value:function(t,i,e,a){for(var n=this.getDatas(),r=new c,s=this.config,h=0,o=n.length;h<o;++h){var u=n[h];b(i,u.position,r,s.blur),r.z=r.z-t;var v=u.temperature;e?d.call(this,a,r,v):f.call(this,a,r,v)}}},{key:"getHeatMap",value:function(t,i,e,a){var n=this.config,r=n.remainMax;t=Math.max(0,t);var s=b(i,this.config.box,{},n.blur),h=[i,Math.min(s.z,t),r].join("_"),o=this.r[h];if(!o){var u=document.createElement("canvas");u.width=s.x,u.height=s.y,this.r[h]=o=u.getContext("2d",{alpha:!0}),o.clearRect(0,0,u.width,u.height),this.renderPoints(t,i,r,o)}if(a){var v=a.canvas;v.width=s.x,v.height=s.y}else{var c=document.createElement("canvas");c.width=s.x,c.height=s.y,a=c.getContext("2d",{alpha:!0})}return this.h[h]=a,this.renderCanvas(e,r,o,a),a.canvas}},{key:"getColorPalette",value:function(t){var i=document.createElement("canvas"),e=i.getContext("2d");i.width=256,i.height=1;var a=e.createLinearGradient(0,0,256,1);for(var n in t)a.addColorStop(n,t[n]);return e.fillStyle=a,e.fillRect(0,0,256,1),e.getImageData(0,0,256,1).data}},{key:"getCanvasMap",value:function(){return this.o}},{key:"getHeatMapValue",value:function(t,i){var e=this.config,a=this.n;if(e.remainMax,a){a.getTall(),a.getScaleTall();var n=(a.getRect(),a.getAnchor3d()),r=(a.getX(),a.getElevation(),n.y,a.getY(),Math.floor(this.e/2));"bottom"===i?r=0:"top"===i&&(r=this.e-1);var s=this.o[this.v[r]];if(!s)return 0;var h=this.g3d.intersectObject(t,a);if(!h)return 0;var o=h.local,u={x:(o.x+.5)*s.width,y:(o.z+.5)*s.height};u.x=parseInt(u.x),u.y=parseInt(u.y);for(var v=s.getContext("2d").getImageData(u.x,u.y,1,1).data,c=e.max,f=e.min,l=0,d=this.palette,y=d.length,p=0;p<y;p++){var g=4*p;if(v[0]===d[g]&&v[1]===d[1+g]&&v[2]===d[2+g]&&v[3]===d[3+g]){l=p;break}}var m=Math.abs(c-f)*(l/255)+f;return m?m.toFixed(1):0}}},{key:"startAnim",value:function(t,i){this.startAnim(t,i)}},{key:"startScan",value:function(){var t=this.g3d;t&&t.dm()}},{key:"stopScan",value:function(){}},{key:"destory",value:function(){this.destoryModels(),this.destoryImage(),this.n.removeFromDataModel()}},{key:"destoryImage",value:function(){var i=p.getImageMap();Object.keys(this.o).forEach(function(t){delete i[t]}),this.o={},this.v=[]}},{key:"destoryModels",value:function(){if(p.getShape3dModelMap){var i=p.getShape3dModelMap();this.u.forEach(function(t){delete i[t]}),this.u=[]}}}]),o);function o(t,i){!function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}(this,o),this.g3d=t,this.config=Object.assign(p.clone(e),i),this.o={},this.u=[],this.v=[],this.r={},this.h={},this.temperatureList=[],this.palette=this.getColorPalette(this.config.gradient)}function l(t){var i=this.config,e=i.step,a=i.colorStopFn,n=i.min,r=i.max,s=this.getPointInfo(t),h=s.value;return{radius:s.radius,step:e,getValue:function(t){var i=Math.max(0,Math.min(1,(h-n)/(r-n)));return a(i,t)}}}function b(t,i,e,a){switch(a=a<=0?1:a,t){case"x":e.x=i.y*a,e.y=i.z*a,e.z=i.x;break;case"y":e.x=i.z*a,e.y=i.x*a,e.z=i.y;break;case"z":e.x=i.x*a,e.y=i.y*a,e.z=i.z}return e}function f(t,i,e){var a=l.call(this,e),n=a.radius*a.radius-i.z*i.z;if(!(n<=0)){for(var r=this.config.blur,s=Math.sqrt(n)*r,h=t.createRadialGradient(i.x,i.y,s,i.x,i.y,0),o=a.getValue((a.radius-Math.abs(i.z))/a.radius),u=a.step,v=0;v<=1;v+=u)h.addColorStop(v,"rgba(0, 0, 0, "+a.getValue(v*o)+")");t.save(),t.fillStyle=h,t.beginPath(),t.arc(i.x,i.y,s,0,2*Math.PI,!1),t.fill(),t.restore()}}function d(t,i,e){var a=l.call(this,e),n=a.radius*a.radius-i.z*i.z;if(!(n<=0)){for(var r=this.config.blur,s=Math.sqrt(n)*r,h=t.createRadialGradient(i.x,i.y,s,i.x,i.y,0),o=a.getValue((a.radius-Math.abs(i.z))/a.radius),u=a.step,v=0;v<=1;v+=u){var c=a.getValue(v*o),f=255*c;h.addColorStop(v,"rgba("+f+", "+f+", "+f+", "+c+")")}t.save(),t.globalCompositeOperation="lighten",t.fillStyle=h,t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore()}}t.Thermodynamic3d=h,Object.defineProperty(t,"__esModule",{value:!0})});
